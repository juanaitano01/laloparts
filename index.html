<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Lalo Part'S</title>
  <style>
    body{font-family:Arial;background:#0d1117;color:#eee;margin:0;padding:20px}
    h2{margin-top:30px}
    input,select,textarea,button{padding:6px;margin:4px;border-radius:6px;border:1px solid #444;background:#161b22;color:#eee}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #333;padding:8px;text-align:left;vertical-align:top}
    th{background:#111}
    .muted{color:#aaa;font-size:12px}
    .tag{padding:2px 6px;border-radius:6px;font-size:12px;background:#222}
    .status-act{background:#2e7d32;color:#fff}
    .status-fin{background:#c62828;color:#fff}
    .thumb{max-width:60px;cursor:pointer;border-radius:6px}
    .btn-warn{background:#fbc02d;color:#000;border:none;padding:4px 8px;margin:2px;cursor:pointer;border-radius:6px}
    .btn-danger{background:#d32f2f;color:#fff;border:none;padding:4px 8px;margin:2px;cursor:pointer;border-radius:6px}
    .btn-finish{background:#1976d2;color:#fff;border:none;padding:4px 8px;margin:2px;border-radius:6px}
    .btn-factura{background:#9c27b0;color:#fff;border:none;padding:4px 8px;margin:2px;border-radius:6px;cursor:pointer}
    .topbar{display:flex;gap:10px;margin-bottom:15px}
    #search{flex:1}
    .stats{margin:20px 0;padding:10px;background:#161b22;border-radius:8px;display:flex;gap:20px}
    .stat{flex:1;padding:10px;text-align:center;border:1px solid #333;border-radius:8px}
    .stat h3{margin:0;font-size:14px;color:#aaa}
    .stat p{margin:5px 0 0;font-size:18px;font-weight:bold}
    .editable{width:80px;text-align:right}
    .card{margin-top:15px;padding:10px;background:#161b22;border-radius:8px}
    .btn{padding:6px 10px;border:none;border-radius:6px;margin:4px;cursor:pointer}
    .btn-pdf{background:#e53935;color:#fff}
    .btn-excel{background:#43a047;color:#fff}
  </style>
</head>
<body>
<h1>Lalo Part'S</h1>

<div class="topbar">
  <button id="btnExportTrabajos">Exportar trabajos</button>
  <button id="btnBackup">Respaldo</button>
  <button id="btnRestore">Restaurar</button>
  <input type="file" id="restoreFile" accept="application/json" hidden>
</div>

<h2>Nuevo trabajo</h2>
<form id="form">
  <input id="cliente" placeholder="Cliente" required>
  <input id="contacto" placeholder="Contacto">
  <input id="producto" placeholder="Producto" required>
  <textarea id="descripcion" placeholder="DescripciÃ³n"></textarea>
  <label>Fecha ingreso: <input type="date" id="fIngreso" required></label>
  <label>Fecha salida: <input type="date" id="fSalida"></label>
  <label>Forma de pago:
    <select id="pago">
      <option>efectivo</option>
      <option>transferencia</option>
      <option>tarjeta</option>
    </select>
  </label>
  <input type="number" id="montoTotal" placeholder="Monto total" required>
  <input type="number" id="montoPagado" placeholder="Monto pagado" required>
  <label>Foto: <input type="file" id="foto" accept="image/*"></label>
  <button type="submit">Guardar</button>
</form>

<div style="margin-top:15px">
  <input type="text" id="search" placeholder="Buscar por cliente, producto, contacto o descripciÃ³n..." style="width:100%">
</div>

<div class="stats">
  <div class="stat">
    <h3>Deuda total</h3>
    <p id="statDeuda">$0</p>
  </div>
  <div class="stat">
    <h3>Trabajos activos</h3>
    <p id="statActivos">0</p>
  </div>
  <div class="stat">
    <h3>Trabajos finalizados</h3>
    <p id="statFinalizados">0</p>
  </div>
</div>

<h2>Trabajos</h2>
<table>
  <thead>
    <tr>
      <th>Cliente</th><th>Producto</th><th>Ingreso</th><th>Salida</th>
      <th>Pago</th><th>Estado</th><th>Foto</th><th>Acciones</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>
<p id="emptyMsg" class="muted">Sin trabajos cargados</p>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const $ = sel => document.querySelector(sel);
let trabajos = [];

function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36)}
function hoyISO(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}

function guardar(){ localStorage.setItem("taller", JSON.stringify(trabajos)); }
function cargar(){
  trabajos = JSON.parse(localStorage.getItem("taller")||"[]");
  render();
  $('#fIngreso').value=hoyISO();
}

function actualizarStats(){
  const deuda = trabajos.reduce((s,t)=>s+t.saldoPendiente,0);
  const activos = trabajos.filter(t=>t.estado==="activo").length;
  const finalizados = trabajos.filter(t=>t.estado==="finalizado").length;
  $('#statDeuda').textContent = "$"+deuda.toFixed(2);
  $('#statActivos').textContent = activos;
  $('#statFinalizados').textContent = finalizados;
}

function render(filtro=""){
  const tbody=$('#tbody');
  tbody.innerHTML='';
  let lista = trabajos;

  if(filtro.trim()!==""){
    const f = filtro.toLowerCase();
    lista = trabajos.filter(t=>
      t.cliente.toLowerCase().includes(f) ||
      t.producto.toLowerCase().includes(f) ||
      (t.contacto && t.contacto.toLowerCase().includes(f)) ||
      (t.descripcion && t.descripcion.toLowerCase().includes(f))
    );
  }

  lista.forEach(t=>{
    const estadoHTML = t.estado==='activo' 
      ? '<span class="tag status-act">ðŸŸ¢ Activo</span>' 
      : '<span class="tag status-fin">ðŸ”´ Finalizado</span>';

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td><b>${t.cliente}</b><div class="muted">${t.contacto||''}</div></td>
      <td>${t.producto}<div class="muted">${t.descripcion||''}</div></td>
      <td>${t.fIngreso}</td>
      <td>${t.fSalida||'-'}</td>
      <td>
        <div><span class="tag">${t.pago}</span></div>
        <div style="font-size:12px">
          Total: <input type="number" class="editable" value="${t.montoTotal}" onchange="actualizarMonto('${t.id}', 'total', this.value)"><br>
          Pagado: <input type="number" class="editable" value="${t.montoPagado}" onchange="actualizarMonto('${t.id}', 'pagado', this.value)"><br>
          Deuda: <span id="deuda-${t.id}">$${t.saldoPendiente.toFixed(2)}</span>
        </div>
      </td>
      <td id="estado-${t.id}">${estadoHTML}</td>
      <td>${t.foto ? `<img src="${t.foto}" class="thumb" onclick="verFoto('${t.id}')">` : '-'}</td>
      <td>
        <button class="btn-warn" onclick="editar('${t.id}')">Editar</button>
        <button class="btn-finish" onclick="marcarFinalizado('${t.id}')">Finalizar</button>
        <button class="btn-danger" onclick="borrar('${t.id}')">Borrar</button>
        ${t.estado==="finalizado"?`<button class="btn-factura" onclick="generarFactura('${t.id}')">Factura</button>`:''}
      </td>`;
    tbody.appendChild(tr);
  });
  $('#emptyMsg').hidden = lista.length>0;
  actualizarStats();
}

function actualizarMonto(id, tipo, valor){
  const t = trabajos.find(x=>x.id===id);
  if(!t) return;
  if(tipo==="total") t.montoTotal = parseFloat(valor)||0;
  if(tipo==="pagado") t.montoPagado = parseFloat(valor)||0;
  t.saldoPendiente = t.montoTotal - t.montoPagado;

  if(t.saldoPendiente <= 0 && t.fSalida){
    t.estado = "finalizado";
  } else {
    t.estado = "activo";
  }
  guardar();
  render($('#search').value);
}

function marcarFinalizado(id){
  const t = trabajos.find(x=>x.id===id);
  if(!t) return;
  t.estado="finalizado";
  if(!t.fSalida) t.fSalida = hoyISO();
  guardar();
  render($('#search').value);
  generarFactura(id);
}

$('#form').addEventListener("submit", e=>{
  e.preventDefault();
  const id = $('#form').dataset.editing || uid();
  const fotoFile = $('#foto').files[0];
  const anterior = trabajos.find(x=>x.id===id);

  if(fotoFile){
    const reader = new FileReader();
    reader.onloadend = ()=>{ guardarTrabajo(reader.result); };
    reader.readAsDataURL(fotoFile);
  } else {
    guardarTrabajo(anterior?.foto || null);
  }

  function guardarTrabajo(foto){
    const montoTotal = parseFloat($('#montoTotal').value) || 0;
    const montoPagado = parseFloat($('#montoPagado').value) || 0;
    const saldo = montoTotal - montoPagado;

    const trabajo = {
      id,
      cliente: $('#cliente').value,
      contacto: $('#contacto').value,
      producto: $('#producto').value,
      descripcion: $('#descripcion').value,
      fIngreso: $('#fIngreso').value,
      fSalida: $('#fSalida').value,
      pago: $('#pago').value,
      montoTotal,
      montoPagado,
      saldoPendiente: saldo,
      estado: (saldo <= 0 && $('#fSalida').value) ? "finalizado" : "activo",
      foto
    };

    if($('#form').dataset.editing){
      trabajos = trabajos.map(t=>t.id===id?trabajo:t);
      delete $('#form').dataset.editing;
    }else{
      trabajos.push(trabajo);
    }

    guardar();
    render($('#search').value);
    $('#form').reset();
    $('#fIngreso').value=hoyISO();
  }
});

function editar(id){
  const t = trabajos.find(x=>x.id===id);
  if(!t) return;
  $('#cliente').value=t.cliente;
  $('#contacto').value=t.contacto;
  $('#producto').value=t.producto;
  $('#descripcion').value=t.descripcion;
  $('#fIngreso').value=t.fIngreso;
  $('#fSalida').value=t.fSalida;
  $('#pago').value=t.pago;
  $('#montoTotal').value=t.montoTotal;
  $('#montoPagado').value=t.montoPagado;
  $('#form').dataset.editing=id;
}

function borrar(id){
  if(confirm("Â¿Borrar trabajo?")){
    trabajos = trabajos.filter(t=>t.id!==id);
    guardar(); render($('#search').value);
  }
}

function verFoto(id){
  const t=trabajos.find(x=>x.id===id);
  if(t?.foto){ const w=window.open(""); w.document.write(`<img src="${t.foto}" style="max-width:100%">`); }
}

$('#search').addEventListener('input', e => render(e.target.value));

async function generarFactura(id){
  const t = trabajos.find(x=>x.id===id);
  if(!t) return;
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();

  // Cabecera
  doc.setFontSize(18);
  doc.setTextColor(0,0,0);
  doc.text("Lalo Part'S", 105, 15, {align:"center"});
  doc.setFontSize(12);
  doc.text("Factura", 105, 25, {align:"center"});

  // Datos cliente
  doc.setFontSize(11);
  doc.text(`Cliente: ${t.cliente}`, 15, 40);
  doc.text(`Contacto: ${t.contacto||'-'}`, 15, 48);
  doc.text(`Producto/Servicio: ${t.producto}`, 15, 56);
  doc.text(`DescripciÃ³n: ${t.descripcion||'-'}`, 15, 64);
  doc.text(`Fecha ingreso: ${t.fIngreso}`, 15, 72);
  doc.text(`Fecha salida: ${t.fSalida||hoyISO()}`, 15, 80);
  doc.text(`Forma de pago: ${t.pago}`, 15, 88);

  // Tabla de pagos
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Lalo Part'S</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
<style>
body { font-family: 'Roboto', sans-serif; background: #121212; color: #f5f5f5; margin: 0; padding: 20px; }
h1 { text-align: center; margin-bottom: 20px; }
h2 { margin-top: 40px; margin-bottom: 10px; }
input, select, textarea, button { padding: 8px; margin: 5px 0; border-radius: 8px; border: 1px solid #333; background: #1e1e1e; color: #f5f5f5; }
button { cursor: pointer; transition: 0.2s; }
button:hover { opacity: 0.85; }
.topbar { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px; }
#search { flex: 1; padding: 8px; border-radius: 8px; border: 1px solid #333; }
.stats { display: flex; gap: 15px; flex-wrap: wrap; margin: 20px 0; }
.stat { flex: 1; padding: 15px; background: #1e1e1e; border-radius: 10px; text-align: center; }
.stat h3 { font-weight: 500; color: #aaa; margin-bottom: 10px; }
.stat p { font-size: 18px; font-weight: 700; }
table { width: 100%; border-collapse: collapse; margin-top: 15px; }
th, td { padding: 10px; border: 1px solid #333; text-align: left; vertical-align: middle; }
th { background: #1a1a1a; }
tr:hover { background: #252525; }
.tag { padding: 3px 8px; border-radius: 8px; font-size: 12px; }
.status-act { background: #2e7d32; color: #fff; }
.status-fin { background: #c62828; color: #fff; }
.thumb { max-width: 60px; border-radius: 8px; cursor: pointer; transition: 0.2s; }
.thumb:hover { transform: scale(1.2); }
.btn-warn { background: #fbc02d; color: #000; }
.btn-danger { background: #d32f2f; color: #fff; }
.btn-finish { background: #1976d2; color: #fff; }
.btn-factura { background: #9c27b0; color: #fff; }
.card { background: #1e1e1e; padding: 15px; border-radius: 10px; margin-top: 20px; }
.editable { width: 80px; text-align: right; background: #121212; border: 1px solid #333; color: #f5f5f5; border-radius: 6px; }
.muted { color: #aaa; font-size: 12px; }
</style>
</head>
<body>
<h1>Lalo Part'S</h1>

<div class="topbar">
  <button id="btnExportTrabajos">Exportar trabajos</button>
  <button id="btnBackup">Respaldo</button>
  <button id="btnRestore">Restaurar</button>
  <input type="file" id="restoreFile" accept="application/json" hidden>
  <input type="text" id="search" placeholder="Buscar por cliente, producto, contacto o descripciÃ³n...">
</div>

<h2>Nuevo trabajo</h2>
<form id="form" class="card">
  <input id="cliente" placeholder="Cliente" required>
  <input id="contacto" placeholder="Contacto">
  <input id="producto" placeholder="Producto" required>
  <textarea id="descripcion" placeholder="DescripciÃ³n"></textarea>
  <label>Fecha ingreso: <input type="date" id="fIngreso" required></label>
  <label>Fecha salida: <input type="date" id="fSalida"></label>
  <label>Forma de pago: 
    <select id="pago">
      <option>efectivo</option>
      <option>transferencia</option>
      <option>tarjeta</option>
    </select>
  </label>
  <input type="number" id="montoTotal" placeholder="Monto total" required>
  <input type="number" id="montoPagado" placeholder="Monto pagado" required>
  <label>Foto inicial: <input type="file" id="foto" accept="image/*"></label>
  <button type="submit">Guardar</button>
</form>

<div class="stats">
  <div class="stat">
    <h3>Deuda total</h3>
    <p id="statDeuda">$0</p>
  </div>
  <div class="stat">
    <h3>Trabajos activos</h3>
    <p id="statActivos">0</p>
  </div>
  <div class="stat">
    <h3>Trabajos finalizados</h3>
    <p id="statFinalizados">0</p>
  </div>
</div>

<h2>Trabajos</h2>
<table>
  <thead>
    <tr>
      <th>Cliente / Remito</th>
      <th>Producto</th>
      <th>Ingreso</th>
      <th>Salida</th>
      <th>Pago</th>
      <th>Estado</th>
      <th>Foto</th>
      <th>Acciones</th>
    </tr>
  </thead>
  <tbody id="tbody"></tbody>
</table>
<p id="emptyMsg" class="muted">Sin trabajos cargados</p>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
const $ = sel => document.querySelector(sel);
let trabajos = [];

function uid(){return Math.random().toString(36).slice(2)+Date.now().toString(36);}
function hoyISO(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
function guardar(){ localStorage.setItem("taller", JSON.stringify(trabajos)); }
function cargar(){ trabajos = JSON.parse(localStorage.getItem("taller")||"[]"); render(); $('#fIngreso').value=hoyISO(); }
function actualizarStats(){
    const deuda = trabajos.reduce((s,t)=>s+t.saldoPendiente,0);
    const activos = trabajos.filter(t=>t.estado==="activo").length;
    const finalizados = trabajos.filter(t=>t.estado==="finalizado").length;
    $('#statDeuda').textContent = "$"+deuda.toFixed(2);
    $('#statActivos').textContent = activos;
    $('#statFinalizados').textContent = finalizados;
}

function render(filtro=""){
    const tbody=$('#tbody'); tbody.innerHTML='';
    let lista = trabajos;
    if(filtro.trim()!==""){
        const f = filtro.toLowerCase();
        lista = trabajos.filter(t=> t.cliente.toLowerCase().includes(f) || t.producto.toLowerCase().includes(f) || (t.contacto && t.contacto.toLowerCase().includes(f)) || (t.descripcion && t.descripcion.toLowerCase().includes(f)) );
    }
    lista.forEach(t=>{
        const estadoHTML = t.estado==='activo' ? '<span class="tag status-act">ðŸŸ¢ Activo</span>' : '<span class="tag status-fin">ðŸ”´ Finalizado</span>';
        const tr=document.createElement("tr");
        tr.innerHTML=`
<td><b>${t.cliente}</b><div class="muted">Remito: ${t.remito}</div><div class="muted">${t.contacto||''}</div></td>
<td>${t.producto}<div class="muted">${t.descripcion||''}</div></td>
<td>${t.fIngreso}</td>
<td>${t.fSalida||'-'}</td>
<td>
<div><span class="tag">${t.pago}</span></div>
<div style="font-size:12px">
 Total: <input type="number" class="editable" value="${t.montoTotal}" onchange="actualizarMonto('${t.id}','total',this.value)"><br>
 Pagado: <input type="number" class="editable" value="${t.montoPagado}" onchange="actualizarMonto('${t.id}','pagado',this.value)"><br>
 Deuda: <span id="deuda-${t.id}">$${t.saldoPendiente.toFixed(2)}</span>
</div>
</td>
<td id="estado-${t.id}">${estadoHTML}</td>
<td>${t.foto ? `<img src="${t.foto}" class="thumb" onclick="verFoto('${t.id}')">`:'-'}</td>
<td>
<button class="btn-warn" onclick="editar('${t.id}')">Editar</button>
<button class="btn-finish" onclick="marcarFinalizado('${t.id}')">Finalizar</button>
<button class="btn-danger" onclick="borrar('${t.id}')">Borrar</button>
${t.estado==="finalizado"?`<button class="btn-factura" onclick="generarFactura('${t.id}')">Factura</button>`:''}
</td>`;
        tbody.appendChild(tr);
    });
    $('#emptyMsg').hidden = lista.length>0;
    actualizarStats();
}

function actualizarMonto(id,tipo,valor){
    const t = trabajos.find(x=>x.id===id); if(!t) return;
    if(tipo==="total") t.montoTotal = parseFloat(valor)||0;
    if(tipo==="pagado") t.montoPagado = parseFloat(valor)||0;
    t.saldoPendiente = t.montoTotal - t.montoPagado;
    if(t.saldoPendiente <= 0 && t.fSalida){ t.estado = "finalizado"; } else { t.estado = "activo"; }
    guardar(); render($('#search').value);
}

function marcarFinalizado(id){
    const t = trabajos.find(x=>x.id===id); if(!t) return;
    t.estado="finalizado";
    if(!t.fSalida) t.fSalida = hoyISO();
    guardar(); render($('#search').value);
}

$('#form').addEventListener("submit", e=>{
    e.preventDefault();
    const id = $('#form').dataset.editing || uid();
    const fotoFile = $('#foto').files[0];
    const anterior = trabajos.find(x=>x.id===id);

    if(fotoFile){
        const reader = new FileReader();
        reader.onloadend = ()=>{ guardarTrabajo(reader.result); };
        reader.readAsDataURL(fotoFile);
    } else {
        guardarTrabajo(anterior?.foto || null);
    }

    function guardarTrabajo(foto){
        const montoTotal = parseFloat($('#montoTotal').value)||0;
        const montoPagado = parseFloat($('#montoPagado').value)||0;
        const saldo = montoTotal - montoPagado;
        let proximoRemito = trabajos.length>0?Math.max(...trabajos.map(t=>t.remito||0))+1:1;

        const trabajo = {
            id,
            remito: $('#form').dataset.editing ? anterior.remito : proximoRemito,
            cliente: $('#cliente').value,
            contacto: $('#contacto').value,
            producto: $('#producto').value,
            descripcion: $('#descripcion').value,
            fIngreso: $('#fIngreso').value,
            fSalida: $('#fSalida').value,
            pago: $('#pago').value,
            montoTotal,
            montoPagado,
            saldoPendiente: saldo,
            estado: (saldo<=0 && $('#fSalida').value)? "finalizado" : "activo",
            foto,
            fotoFinal: anterior?.fotoFinal || null
        };

        if($('#form').dataset.editing){
            trabajos = trabajos.map(t=>t.id===id?trabajo:t);
            delete $('#form').dataset.editing;
        } else { trabajos.push(trabajo); }

        guardar(); render($('#search').value);
        $('#form').reset();
        $('#fIngreso').value=hoyISO();
    }
});

function editar(id){
    const t = trabajos.find(x=>x.id===id); if(!t) return;
    $('#cliente').value=t.cliente;
    $('#contacto').value=t.contacto;
    $('#producto').value=t.producto;
    $('#descripcion').value=t.descripcion;
    $('#fIngreso').value=t.fIngreso;
    $('#fSalida').value=t.fSalida;
    $('#pago').value=t.pago;
    $('#montoTotal').value=t.montoTotal;
    $('#montoPagado').value=t.montoPagado;
    $('#form').dataset.editing=id;
}

function borrar(id){ if(confirm("Â¿Borrar trabajo?")){ trabajos = trabajos.filter(t=>t.id!==id); guardar(); render($('#search').value); } }
function verFoto(id){ const t=trabajos.find(x=>x.id===id); if(t?.foto){ const w=window.open(""); w.document.write(`<img src="${t.foto}" style="max-width:100%">`); } }
$('#search').addEventListener('input', e => render(e.target.value));

async function generarFactura(id){
    const t = trabajos.find(x=>x.id===id);
    if(!t) return;

    // Pedir foto final si no existe
    if(!t.fotoFinal){
        const input = document.createElement('input');
        input.type='file';
        input.accept='image/*';
        input.onchange = e => {
            const file = e.target.files[0];
            if(file){
                const reader = new FileReader();
                reader.onloadend = ()=>{
                    t.fotoFinal = reader.result;
                    guardar();
                    generarFactura(id); // llamar nuevamente con foto final
                };
                reader.readAsDataURL(file);
            }
        };
        input.click();
        return; // esperar a cargar la foto
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.setFontSize(18); doc.setTextColor(0,0,0);
    doc.text("Lalo Part'S", 105, 15, {align:"center"});
    doc.setFontSize(12); doc.text("Factura", 105, 25, {align:"center"});
    doc.setFontSize(11);
    doc.text(`Remito: ${t.remito}`, 15, 40);
    doc.text(`Cliente: ${t.cliente}`, 15, 48);
    doc.text(`Contacto: ${t.contacto||'-'}`, 15, 56);
    doc.text(`Producto/Servicio: ${t.producto}`, 15, 64);
    doc.text(`DescripciÃ³n: ${t.descripcion||'-'}`, 15, 72);
    doc.text(`Fecha ingreso: ${t.fIngreso}`, 15, 80);
    doc.text(`Fecha salida: ${t.fSalida||hoyISO()}`, 15, 88);
    doc.text(`Forma de pago: ${t.pago}`, 15, 96);

    doc.autoTable({
        startY:105,
        head:[['Monto Total','Pagado','Deuda']],
        body:[[`$${t.montoTotal.toFixed(2)}`,`$${t.montoPagado.toFixed(2)}`,`$${t.saldoPendiente.toFixed(2)}`]],
        styles:{textColor:[0,0,0], halign:'center'},
        headStyles:{fillColor:[255,255,255], textColor:[0,0,0], halign:'center', lineColor:[0,0,0], lineWidth:0.5},
        bodyStyles:{lineColor:[0,0,0], lineWidth:0.5}
    });

    let yPos=130;
    if(t.foto){
        const img1=new Image(); img1.src=t.foto;
        await new Promise(r=>img1.onload=r);
        doc.text("Foto inicial:", 15, yPos-2);
        doc.addImage(img1,'JPEG',15,yPos,60,60);
    }
    if(t.fotoFinal){
        const img2=new Image(); img2.src=t.fotoFinal;
        await new Promise(r=>img2.onload=r);
        doc.text("Foto final:", 90, yPos-2);
        doc.addImage(img2,'JPEG',90,yPos,60,60);
    }

    doc.save(`Factura_${t.cliente.replace(/\s/g,'_')}.pdf`);
}

// Autoload jspdf-autotable si falta
(function(){
    if(!window.jspdf.jsPDF?.autoTable){
        const script = document.createElement('script');
        script.src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js";
        document.head.appendChild(script);
    }
})();

cargar();
</script>
</body>
</html>
